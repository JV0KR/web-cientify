<div class="perfil-container">
  <!-- Loading -->
  <div *ngIf="loading" class="loading">
    <p>Cargando perfil...</p>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="alert alert-error">
    {{ error }}
  </div>

  <!-- Success Message -->
  <div *ngIf="success" class="alert alert-success">
    {{ success }}
  </div>

  <!-- Perfil View -->
  <div *ngIf="!loading && user && !isEditing" class="profile-view">
    <!-- Profile Header (no cover) -->
    <div class="profile-header">
      <div class="profile-info">
        <!-- Avatar -->
        <div class="avatar-container">
          <div class="avatar" [ngStyle]="{ backgroundColor: getRolColor() }">
            <img *ngIf="user.avatarUrl" [src]="user.avatarUrl" alt="{{ user.nombre }}" />
            <span *ngIf="!user.avatarUrl">{{ getInitials() }}</span>
          </div>
        </div>
        <!-- User Info -->
        <div class="user-info">
          <h1>{{ user.nombre }}</h1>
          <p class="email">{{ user.email }}</p>
          <div class="rol-badge" [ngStyle]="{ backgroundColor: getRolColor() }">
            {{ user.rol | uppercase }}
          </div>
          <p class="bio" *ngIf="user.bio">{{ user.bio }}</p>
          <p class="joined-date">Miembro desde {{ formatDate(user.createdAt) }}</p>
        </div>
        <!-- Stats -->
        <div class="profile-stats">
          <div class="stat">
            <span class="stat-label">Seguidores</span>
            <span class="stat-value">{{ user.followersCount || 0 }}</span>
          </div>
          <div class="stat">
            <span class="stat-label">Siguiendo</span>
            <span class="stat-value">{{ user.followingCount || 0 }}</span>
          </div>
        </div>
      </div>
      <!-- Action Buttons -->
      <div class="profile-actions">
        <button class="btn btn-secondary" (click)="toggleEdit()" title="Editar perfil">
          âœï¸ Editar Perfil
        </button>
        <button class="btn btn-secondary" (click)="setActiveTab('settings')" title="ConfiguraciÃ³n">
          âš™ï¸ ConfiguraciÃ³n
        </button>
        <button class="btn btn-danger" (click)="logout()" title="Cerrar sesiÃ³n">
          ğŸšª Cerrar SesiÃ³n
        </button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="profile-tabs-container">
      <div class="profile-tabs-header">
        <button
          [class.active]="activeTab === 'posts'"
          (click)="setActiveTab('posts')"
          class="tab-button"
        >
          ğŸ“ Mis Posts
        </button>
        <button
          [class.active]="activeTab === 'saved'"
          (click)="setActiveTab('saved')"
          class="tab-button"
        >
          ğŸ’¾ Guardados ({{ savedPosts.length }})
        </button>
      </div>

      <!-- Posts Tab -->
      <div class="profile-tabs-content" *ngIf="activeTab === 'posts'">
        <div *ngIf="postsLoading" class="loading">
          <p>Cargando posts...</p>
        </div>
        <div *ngIf="!postsLoading && userPosts.length === 0" class="empty-state">
          <p>AÃºn no tienes posts. Â¡Crea uno desde el Feed!</p>
        </div>
        <div *ngIf="!postsLoading && userPosts.length > 0" class="posts-grid">
          <div *ngFor="let post of userPosts" class="post-card">
            <div class="post-card-header">
              <h3>{{ post.title }}</h3>
              <span class="post-status" [class.published]="post.published">
                {{ post.published ? 'âœ“ Publicado' : 'ğŸ”’ Borrador' }}
              </span>
            </div>
            <p class="post-summary">{{ post.subtitle || post.summary }}</p>
            <div class="post-meta">
              <small class="post-date">{{ formatDate(post.createdAt) }}</small>
              <div class="post-stats">
                <span>â¤ï¸ {{ post.likes?.length || 0 }}</span>
                <span>ğŸ’¾ {{ post.guardados?.length || 0 }}</span>
              </div>
            </div>
            <div class="post-actions">
              <button
                class="btn btn-sm btn-secondary"
                (click)="togglePublishPost(post)"
                [title]="post.published ? 'Ocultar post' : 'Publicar post'"
              >
                {{ post.published ? 'ğŸ”“' : 'ğŸ”’' }} {{ post.published ? 'Ocultar' : 'Publicar' }}
              </button>
              <button
                class="btn btn-sm btn-danger"
                (click)="deletePost(post._id, post.title)"
                title="Eliminar post"
              >
                ğŸ—‘ï¸ Eliminar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Saved Posts Tab -->
      <div class="profile-tabs-content" *ngIf="activeTab === 'saved'">
        <div *ngIf="savedPosts.length === 0" class="empty-state">
          <p>AÃºn no has guardado ningÃºn post.</p>
        </div>
        <div *ngIf="savedPosts.length > 0" class="posts-grid">
          <div *ngFor="let post of savedPosts" class="post-card">
            <div class="post-card-header">
              <h3>{{ post.title }}</h3>
              <span class="post-author">{{ post.author?.nombre || 'AnÃ³nimo' }}</span>
            </div>
            <p class="post-summary">{{ post.subtitle || post.summary }}</p>
            <div class="post-meta">
              <small class="post-date">{{ formatDate(post.createdAt) }}</small>
              <div class="post-stats">
                <span>â¤ï¸ {{ post.likes?.length || 0 }}</span>
                <span>ğŸ’¾ {{ post.guardados?.length || 0 }}</span>
              </div>
            </div>
            <div class="post-actions">
              <button
                class="btn btn-sm btn-danger"
                (click)="unsavePost(post._id)"
                title="Remover de guardados"
              >
                ğŸ—‘ï¸ Remover
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div class="profile-tabs-content" *ngIf="activeTab === 'settings'">
        <h2>ConfiguraciÃ³n de Cuenta</h2>
        <form class="settings-form" (ngSubmit)="saveSettings()">
          <div class="settings-group">
            <label>
              <input type="checkbox" [(ngModel)]="settings.darkMode" name="darkMode" />
              ğŸŒ™ Modo oscuro
            </label>
          </div>
          <div class="settings-group">
            <label>
              <input type="checkbox" [(ngModel)]="settings.privateProfile" name="privateProfile" />
              ğŸ”’ Perfil privado
            </label>
          </div>
          <div class="settings-actions">
            <button type="submit" class="btn btn-primary">Guardar configuraciÃ³n</button>
          </div>
        </form>
        <div class="settings-status" *ngIf="settingsSaved">
          <span class="alert alert-success">âœ“ ConfiguraciÃ³n guardada correctamente</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Profile Form -->
  <div *ngIf="!loading && user && isEditing" class="profile-edit">
    <div class="edit-header">
      <h2>Editar Perfil</h2>
      <button class="close-btn" (click)="cancelEdit()">âœ•</button>
    </div>

    <form (ngSubmit)="saveProfile()" class="edit-form">
      <!-- Avatar Upload -->
      <div class="form-section">
        <h3>Foto de Perfil</h3>
        <div class="avatar-upload">
          <div class="avatar-preview" [ngStyle]="{ backgroundColor: getRolColor() }">
            <img
              *ngIf="avatarPreview"
              [src]="avatarPreview"
              alt="Preview"
            />
            <img
              *ngIf="!avatarPreview && user.avatarUrl"
              [src]="user.avatarUrl"
              alt="{{ user.nombre }}"
            />
            <span *ngIf="!avatarPreview && !user.avatarUrl">
              {{ getInitials() }}
            </span>
          </div>
          <div class="upload-area">
            <input
              type="file"
              accept="image/*"
              (change)="onAvatarSelected($event)"
              class="file-input"
              id="avatar-input"
            />
            <label for="avatar-input" class="upload-label">
              ğŸ“¸ Cambiar foto de perfil
            </label>
            <p class="upload-hint">JPG, PNG. MÃ¡ximo 5MB</p>
          </div>
        </div>
      </div>

      <!-- Basic Info -->
      <div class="form-section">
        <h3>InformaciÃ³n BÃ¡sica</h3>

        <div class="form-group">
          <label>Nombre Completo *</label>
          <input
            type="text"
            [(ngModel)]="editForm.nombre"
            name="nombre"
            required
            minlength="3"
            maxlength="100"
            placeholder="Tu nombre completo"
            class="form-control"
          />
          <small *ngIf="editForm.nombre.length < 3" class="error-text">
            El nombre debe tener al menos 3 caracteres
          </small>
        </div>

        <div class="form-group">
          <label>Email *</label>
          <input
            type="email"
            [(ngModel)]="editForm.email"
            name="email"
            required
            email
            placeholder="tu@email.com"
            class="form-control"
          />
        </div>

        <div class="form-group">
          <label>Rol</label>
           <div class="form-control-static">
             <span class="badge" [ngStyle]="{ backgroundColor: getRolColor() }">
               {{ user.rol | uppercase }}
             </span>
           </div>
           <small class="form-hint">
             El rol es asignado por un administrador
           </small>
        </div>
      </div>

      <!-- Biography -->
      <div class="form-section">
        <h3>BiografÃ­a</h3>
        <div class="form-group">
          <label>Sobre ti</label>
          <textarea
            [(ngModel)]="editForm.bio"
            name="bio"
            maxlength="500"
            rows="5"
            placeholder="CuÃ©ntanos sobre ti, tus intereses cientÃ­ficos, especialidades..."
            class="form-control"
          ></textarea>
          <small class="char-count">
            {{ editForm.bio.length }}/500
          </small>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button
          type="submit"
          [disabled]="!editForm.nombre || !editForm.email || editForm.nombre.length < 3 || loading"
          class="btn btn-primary btn-large"
        >
          {{ loading ? 'Guardando...' : 'ğŸ’¾ Guardar Cambios' }}
        </button>
        <button
          type="button"
          (click)="cancelEdit()"
          [disabled]="loading"
          class="btn btn-secondary btn-large"
        >
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>
