<div class="perfil-container">
  <!-- Loading -->
  <div *ngIf="loading" class="loading">
    <p>Cargando perfil...</p>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="alert alert-error">
    {{ error }}
  </div>

  <!-- Success Message -->
  <div *ngIf="success" class="alert alert-success">
    {{ success }}
  </div>

  <!-- Perfil View -->
  <div *ngIf="!loading && user && !isEditing" class="profile-view">
    <!-- Profile Header (no cover) -->
    <div class="profile-header">
      <div class="profile-info">
        <!-- Avatar -->
        <div class="avatar-container">
          <div class="avatar" [ngStyle]="{ backgroundColor: getRolColor() }">
            <img *ngIf="user.avatarUrl" [src]="user.avatarUrl" alt="{{ user.nombre }}" />
            <span *ngIf="!user.avatarUrl">{{ getInitials() }}</span>
          </div>
        </div>
        <!-- User Info -->
        <div class="user-info">
          <h1>{{ user.nombre }}</h1>
          <p class="email">{{ user.email }}</p>
          <div class="rol-badge" [ngStyle]="{ backgroundColor: getRolColor() }">
            {{ user.rol | uppercase }}
          </div>
          <p class="bio" *ngIf="user.bio">{{ user.bio }}</p>
          <p class="joined-date">Miembro desde {{ formatDate(user.createdAt) }}</p>
        </div>
        <!-- Stats -->
        <div class="profile-stats">
          <div class="stat">
            <span class="stat-label">Seguidores</span>
            <span class="stat-value">{{ user.followersCount || 0 }}</span>
          </div>
          <div class="stat">
            <span class="stat-label">Siguiendo</span>
            <span class="stat-value">{{ user.followingCount || 0 }}</span>
          </div>
        </div>
      </div>
      <!-- Action Buttons -->
      <div class="profile-actions">
        <button class="btn btn-secondary" (click)="toggleEdit()" title="Editar perfil">
           Editar Perfil
        </button>
        <button class="btn btn-secondary" (click)="setActiveTab('settings')" title="Configuraci√≥n">
          Configuraci√≥n
        </button>
        <button class="btn btn-danger" (click)="logout()" title="Cerrar sesi√≥n">
         Cerrar Sesi√≥n
        </button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="profile-tabs-container">
      <div class="profile-tabs-header">
        <button
          [class.active]="activeTab === 'posts'"
          (click)="setActiveTab('posts')"
          class="tab-button"
        >
          Mis Posts
        </button>
        <button
          [class.active]="activeTab === 'saved'"
          (click)="setActiveTab('saved')"
          class="tab-button"
        >
          Guardados ({{ savedPosts.length }})
        </button>
      </div>

      <!-- Posts Tab -->
      <div class="profile-tabs-content" *ngIf="activeTab === 'posts'">
        <div *ngIf="postsLoading" class="loading">
          <p>Cargando posts...</p>
        </div>
        <div *ngIf="!postsLoading && userPosts.length === 0" class="empty-state">
          <p>A√∫n no tienes posts. ¬°Crea uno desde el Feed!</p>
        </div>
        <div *ngIf="!postsLoading && userPosts.length > 0" class="posts-grid">
          <div *ngFor="let post of userPosts" class="post-card">
            <!-- Post Editing Form -->
            <div *ngIf="editingPostId === post._id" class="post-edit-form">
              <div class="edit-form-header">
                <h4>Editar Post</h4>
                <button class="close-btn" (click)="cancelEditPost()">‚úï</button>
              </div>
              <form (ngSubmit)="saveEditPost()" class="post-form">
                <div class="form-group">
                  <label>T√≠tulo *</label>
                  <input
                    type="text"
                    [(ngModel)]="postEditForm.title"
                    name="title"
                    required
                    placeholder="T√≠tulo del post"
                    class="form-control"
                  />
                </div>
                <div class="form-group">
                  <label>Subt√≠tulo</label>
                  <input
                    type="text"
                    [(ngModel)]="postEditForm.subtitle"
                    name="subtitle"
                    placeholder="Subt√≠tulo (opcional)"
                    class="form-control"
                  />
                </div>
                <div class="form-group">
                  <label>Resumen</label>
                  <input
                    type="text"
                    [(ngModel)]="postEditForm.summary"
                    name="summary"
                    placeholder="Resumen breve del post"
                    class="form-control"
                  />
                </div>
                <div class="form-group">
                  <label>Contenido *</label>
                  <textarea
                    [(ngModel)]="postEditForm.content"
                    name="content"
                    required
                    rows="6"
                    placeholder="Contenido del post"
                    class="form-control"
                  ></textarea>
                </div>
                <div class="form-group">
                  <label>Etiquetas (separadas por comas)</label>
                  <input
                    type="text"
                    [(ngModel)]="postEditForm.tags"
                    name="tags"
                    placeholder="python, ciencia, investigaci√≥n"
                    class="form-control"
                  />
                </div>
                <div class="form-group">
                  <label>Imagen (opcional)</label>
                  <input
                    type="file"
                    accept="image/*"
                    (change)="onPostFileSelected($event)"
                    class="form-control"
                  />
                </div>
                <div class="form-group">
                  <label>
                    <input type="checkbox" [(ngModel)]="postEditForm.published" name="published" />
                     Publicar inmediatamente
                  </label>
                </div>
                <div class="form-actions">
                  <button type="submit" [disabled]="loading" class="btn btn-primary btn-sm">
                    {{ loading ? 'Guardando...' : 'Guardar Cambios' }}
                  </button>
                  <button type="button" (click)="cancelEditPost()" [disabled]="loading" class="btn btn-secondary btn-sm">
                    Cancelar
                  </button>
                </div>
              </form>
            </div>

            <!-- Post Display -->
            <div *ngIf="editingPostId !== post._id" class="post-content">
              <div class="post-card-header">
                <h3>{{ post.title }}</h3>
                <span class="post-status" [class.published]="post.published">
                  {{ post.published ? '‚úì Publicado' : 'üîí Borrador' }}
                </span>
              </div>
              <p class="post-summary">{{ post.subtitle || post.summary }}</p>
              <div class="post-meta">
                <small class="post-date">{{ formatDate(post.createdAt) }}</small>
                <div class="post-stats">
                  <span>‚ù§Ô∏è {{ post.likes?.length || 0 }}</span>
                  <span>üíæ {{ post.guardados?.length || 0 }}</span>
                </div>
              </div>
              <div class="post-actions">
                <button
                  class="btn btn-sm btn-secondary"
                  (click)="startEditPost(post)"
                  title="Editar post"
                >
                   Editar
                </button>
                <button
                  class="btn btn-sm btn-secondary"
                  (click)="togglePublishPost(post)"
                  [title]="post.published ? 'Ocultar post' : 'Publicar post'"
                >
                  {{ post.published ? 'üîì' : 'üîí' }} {{ post.published ? 'Ocultar' : 'Publicar' }}
                </button>
                <button
                  class="btn btn-sm btn-danger"
                  (click)="deletePost(post._id, post.title)"
                  title="Eliminar post"
                >
                   Eliminar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Saved Posts Tab -->
      <div class="profile-tabs-content" *ngIf="activeTab === 'saved'">
        <div *ngIf="savedPosts.length === 0" class="empty-state">
          <p>A√∫n no has guardado ning√∫n post.</p>
        </div>
        <div *ngIf="savedPosts.length > 0" class="posts-grid">
          <div *ngFor="let post of savedPosts" class="post-card">
            <div class="post-card-header">
              <h3>{{ post.title }}</h3>
              <span class="post-author">{{ post.author?.nombre || 'An√≥nimo' }}</span>
            </div>
            <p class="post-summary">{{ post.subtitle || post.summary }}</p>
            <div class="post-meta">
              <small class="post-date">{{ formatDate(post.createdAt) }}</small>
              <div class="post-stats">
                <span>‚ù§Ô∏è {{ post.likes?.length || 0 }}</span>
                <span>üíæ {{ post.guardados?.length || 0 }}</span>
              </div>
            </div>
            <div class="post-actions">
              <button
                class="btn btn-sm btn-danger"
                (click)="unsavePost(post._id)"
                title="Remover de guardados"
              >
                Remover
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div class="profile-tabs-content" *ngIf="activeTab === 'settings'">
        <h2>Configuraci√≥n de Cuenta</h2>

        <!-- Theme Settings -->
        <div class="settings-section">
          <h3>Apariencia</h3>
          <form class="settings-form" (ngSubmit)="saveSettings()">
            <div class="settings-group">
              <label>
                <input type="checkbox" [(ngModel)]="settings.darkMode" name="darkMode" />
                 Modo oscuro
              </label>
              <small class="settings-hint">Activa el modo oscuro para una mejor experiencia visual en espacios con poca luz</small>
            </div>
            <div class="settings-actions">
              <button type="submit" class="btn btn-primary">Guardar configuraci√≥n</button>
            </div>
          </form>
        </div>

        <!-- Delete Account Section -->
        <div class="settings-section danger-zone">

          <!-- Initial State -->
          <div *ngIf="deleteAccountStep === 0" class="delete-account-initial">
            <p class="delete-warning">La eliminaci√≥n de tu cuenta es permanente e irreversible. Se eliminar√°n todos tus datos, posts y comentarios.</p>
            <button
              type="button"
              class="btn btn-danger"
              (click)="initiateDeleteAccount()"
              title="Iniciar proceso de eliminaci√≥n de cuenta"
            >
               Eliminar mi Cuenta
            </button>
          </div>

          <!-- Confirmation Step 1 - Text Entry -->
          <div *ngIf="deleteAccountStep === 1" class="delete-account-confirmation">
            <p class="confirm-message">Para confirmar que deseas eliminar tu cuenta, escribe exactamente:</p>
            <code class="confirmation-text">eliminar mi cuenta</code>
            <div class="form-group">
              <input
                type="text"
                [(ngModel)]="deleteAccountConfirmation"
                name="deleteConfirmation"
                placeholder="Escribe el texto de confirmaci√≥n aqu√≠"
                class="form-control confirmation-input"
              />
            </div>
            <div class="confirmation-actions">
              <button
                type="button"
                class="btn btn-danger"
                (click)="checkDeleteConfirmation()"
                [disabled]="deleteAccountConfirmation.toLowerCase() !== 'eliminar mi cuenta'"
              >
                Continuar con la Eliminaci√≥n
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                (click)="cancelDeleteAccount()"
              >
                Cancelar
              </button>
            </div>
          </div>

          <!-- Confirmation Step 2 - Final Warning -->
          <div *ngIf="deleteAccountStep === 2" class="delete-account-final">
            <div class="final-warning">
              <p class="warning-title">√öLTIMA ADVERTENCIA</p>
              <p>Esta es tu √∫ltima oportunidad para cambiar de opini√≥n. Al hacer clic en "Eliminar permanentemente", tu cuenta ser√° eliminada de forma irreversible.</p>
              <ul class="deletion-consequences">
                <li>‚úó Se eliminar√°n todos tus posts y comentarios</li>
                <li>‚úó Se perder√°n todos tus seguidores y relaciones</li>
                <li>‚úó Se borrar√°n tus datos de perfil</li>
                <li>‚úó Esta acci√≥n NO se puede deshacer</li>
              </ul>
            </div>
            <div class="confirmation-actions">
              <button
                type="button"
                class="btn btn-danger"
                (click)="deleteAccount()"
                [disabled]="loading"
              >
                {{ loading ? 'Eliminando cuenta...' : 'Eliminar Permanentemente' }}
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                (click)="cancelDeleteAccount()"
                [disabled]="loading"
              >
                Cancelar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Profile Form -->
  <div *ngIf="!loading && user && isEditing" class="profile-edit">
    <div class="edit-header">
      <h2>Editar Perfil</h2>
      <button class="close-btn" (click)="cancelEdit()">‚úï</button>
    </div>

    <form (ngSubmit)="saveProfile()" class="edit-form">
      <!-- Avatar Upload -->
      <div class="form-section">
        <h3>Foto de Perfil</h3>
        <div class="avatar-upload">
          <div class="avatar-preview" [ngStyle]="{ backgroundColor: getRolColor() }">
            <img
              *ngIf="avatarPreview"
              [src]="avatarPreview"
              alt="Preview"
            />
            <img
              *ngIf="!avatarPreview && user.avatarUrl"
              [src]="user.avatarUrl"
              alt="{{ user.nombre }}"
            />
            <span *ngIf="!avatarPreview && !user.avatarUrl">
              {{ getInitials() }}
            </span>
          </div>
          <div class="upload-area">
            <input
              type="file"
              accept="image/*"
              (change)="onAvatarSelected($event)"
              class="file-input"
              id="avatar-input"
            />
            <label for="avatar-input" class="upload-label">
              Cambiar foto de perfil
            </label>
            <p class="upload-hint">JPG, PNG. M√°ximo 5MB</p>
          </div>
        </div>
      </div>

      <!-- Basic Info -->
      <div class="form-section">
        <h3>Informaci√≥n B√°sica</h3>

        <div class="form-group">
          <label>Nombre Completo *</label>
          <input
            type="text"
            [(ngModel)]="editForm.nombre"
            name="nombre"
            required
            minlength="3"
            maxlength="100"
            placeholder="Tu nombre completo"
            class="form-control"
          />
          <small *ngIf="editForm.nombre.length < 3" class="error-text">
            El nombre debe tener al menos 3 caracteres
          </small>
        </div>

        <div class="form-group">
          <label>Email *</label>
          <input
            type="email"
            [(ngModel)]="editForm.email"
            name="email"
            required
            email
            placeholder="tu@email.com"
            class="form-control"
          />
        </div>

        <div class="form-group">
          <label>Rol</label>
           <div class="form-control-static">
             <span class="badge" [ngStyle]="{ backgroundColor: getRolColor() }">
               {{ user.rol | uppercase }}
             </span>
           </div>
           <small class="form-hint">
             El rol es asignado por un administrador
           </small>
        </div>
      </div>

      <!-- Biography -->
      <div class="form-section">
        <h3>Biograf√≠a</h3>
        <div class="form-group">
          <label>Sobre ti</label>
          <textarea
            [(ngModel)]="editForm.bio"
            name="bio"
            maxlength="500"
            rows="5"
            placeholder="Cu√©ntanos sobre ti, tus intereses cient√≠ficos, especialidades..."
            class="form-control"
          ></textarea>
          <small class="char-count">
            {{ editForm.bio.length }}/500
          </small>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button
          type="submit"
          [disabled]="!editForm.nombre || !editForm.email || editForm.nombre.length < 3 || loading"
          class="btn btn-primary btn-large"
        >
          {{ loading ? 'Guardando...' : 'Guardar Cambios' }}
        </button>
        <button
          type="button"
          (click)="cancelEdit()"
          [disabled]="loading"
          class="btn btn-secondary btn-large"
        >
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>
